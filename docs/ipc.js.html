<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>ipc.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BoundIpc.html">BoundIpc</a><ul class='methods'><li data-type='method'><a href="BoundIpc.html#off">off</a></li><li data-type='method'><a href="BoundIpc.html#on">on</a></li><li data-type='method'><a href="BoundIpc.html#once">once</a></li><li data-type='method'><a href="BoundIpc.html#send">send</a></li><li data-type='method'><a href="BoundIpc.html#sendOn">sendOn</a></li></ul></li><li><a href="Browser.html">Browser</a><ul class='methods'><li data-type='method'><a href="Browser.html#bringToFront">bringToFront</a></li><li data-type='method'><a href="Browser.html#build">build</a></li><li data-type='method'><a href="Browser.html#close">close</a></li><li data-type='method'><a href="Browser.html#frontPage">frontPage</a></li><li data-type='method'><a href="Browser.html#getBoundingClientRect">getBoundingClientRect</a></li><li data-type='method'><a href="Browser.html#getPageById">getPageById</a></li><li data-type='method'><a href="Browser.html#init">init</a></li><li data-type='method'><a href="Browser.html#newPage">newPage</a></li><li data-type='method'><a href="Browser.html#pages">pages</a></li></ul></li><li></li><li><a href="BrowserManager.html">BrowserManager</a><ul class='methods'><li data-type='method'><a href="BrowserManager.html#frontBrowser">frontBrowser</a></li><li data-type='method'><a href="BrowserManager.html#get">get</a></li><li data-type='method'><a href="BrowserManager.html#launch">launch</a></li></ul></li><li></li><li><a href="ElementHandle.html">ElementHandle</a><ul class='methods'><li data-type='method'><a href="ElementHandle.html#$">$</a></li><li data-type='method'><a href="ElementHandle.html#$$">$$</a></li><li data-type='method'><a href="ElementHandle.html#$$eval">$$eval</a></li><li data-type='method'><a href="ElementHandle.html#$eval">$eval</a></li><li data-type='method'><a href="ElementHandle.html#$x">$x</a></li><li data-type='method'><a href="ElementHandle.html#asElement">asElement</a></li><li data-type='method'><a href="ElementHandle.html#blur">blur</a></li><li data-type='method'><a href="ElementHandle.html#boxModel">boxModel</a></li><li data-type='method'><a href="ElementHandle.html#check">check</a></li><li data-type='method'><a href="ElementHandle.html#click">click</a></li><li data-type='method'><a href="ElementHandle.html#contentFrame">contentFrame</a></li><li data-type='method'><a href="ElementHandle.html#dispose">dispose</a></li><li data-type='method'><a href="ElementHandle.html#executionContext">executionContext</a></li><li data-type='method'><a href="ElementHandle.html#focus">focus</a></li><li data-type='method'><a href="ElementHandle.html#getAttribute">getAttribute</a></li><li data-type='method'><a href="ElementHandle.html#getAttributes">getAttributes</a></li><li data-type='method'><a href="ElementHandle.html#getBoundingClientRect">getBoundingClientRect</a></li><li data-type='method'><a href="ElementHandle.html#getProperties">getProperties</a></li><li data-type='method'><a href="ElementHandle.html#getProperty">getProperty</a></li><li data-type='method'><a href="ElementHandle.html#hover">hover</a></li><li data-type='method'><a href="ElementHandle.html#isIntersectingViewport">isIntersectingViewport</a></li><li data-type='method'><a href="ElementHandle.html#jsonValue">jsonValue</a></li><li data-type='method'><a href="ElementHandle.html#press">press</a></li><li data-type='method'><a href="ElementHandle.html#screenshot">screenshot</a></li><li data-type='method'><a href="ElementHandle.html#tap">tap</a></li><li data-type='method'><a href="ElementHandle.html#toString">toString</a></li><li data-type='method'><a href="ElementHandle.html#type">type</a></li><li data-type='method'><a href="ElementHandle.html#uncheck">uncheck</a></li><li data-type='method'><a href="ElementHandle.html#uploadFile">uploadFile</a></li></ul></li><li></li><li><a href="EventEmitter.html">EventEmitter</a><ul class='methods'><li data-type='method'><a href="EventEmitter.html#.noConflict">noConflict</a></li></ul></li><li><a href="Frame.html">Frame</a><ul class='methods'><li data-type='method'><a href="Frame.html#addScriptTag">addScriptTag</a></li><li data-type='method'><a href="Frame.html#addStyleTag">addStyleTag</a></li><li data-type='method'><a href="Frame.html#blur">blur</a></li><li data-type='method'><a href="Frame.html#childFrames">childFrames</a></li><li data-type='method'><a href="Frame.html#click">click</a></li><li data-type='method'><a href="Frame.html#content">content</a></li><li data-type='method'><a href="Frame.html#evaluate">evaluate</a></li><li data-type='method'><a href="Frame.html#focus">focus</a></li><li data-type='method'><a href="Frame.html#goto">goto</a></li><li data-type='method'><a href="Frame.html#hover">hover</a></li><li data-type='method'><a href="Frame.html#isDetached">isDetached</a></li><li data-type='method'><a href="Frame.html#localStorageGet">localStorageGet</a></li><li data-type='method'><a href="Frame.html#localStorageKeys">localStorageKeys</a></li><li data-type='method'><a href="Frame.html#localStorageRemove">localStorageRemove</a></li><li data-type='method'><a href="Frame.html#localStorageSet">localStorageSet</a></li><li data-type='method'><a href="Frame.html#name">name</a></li><li data-type='method'><a href="Frame.html#page">page</a></li><li data-type='method'><a href="Frame.html#parentFrame">parentFrame</a></li><li data-type='method'><a href="Frame.html#select">select</a></li><li data-type='method'><a href="Frame.html#setContent">setContent</a></li><li data-type='method'><a href="Frame.html#tap">tap</a></li><li data-type='method'><a href="Frame.html#title">title</a></li><li data-type='method'><a href="Frame.html#type">type</a></li><li data-type='method'><a href="Frame.html#url">url</a></li><li data-type='method'><a href="Frame.html#waitFor">waitFor</a></li><li data-type='method'><a href="Frame.html#waitForFunction">waitForFunction</a></li><li data-type='method'><a href="Frame.html#waitForNavigation">waitForNavigation</a></li><li data-type='method'><a href="Frame.html#waitForSelector">waitForSelector</a></li><li data-type='method'><a href="Frame.html#waitForXPath">waitForXPath</a></li></ul></li><li></li><li><a href="Ipc.html">Ipc</a><ul class='methods'><li data-type='method'><a href="Ipc.html#off">off</a></li><li data-type='method'><a href="Ipc.html#on">on</a></li><li data-type='method'><a href="Ipc.html#once">once</a></li><li data-type='method'><a href="Ipc.html#send">send</a></li><li data-type='method'><a href="Ipc.html#sendOn">sendOn</a></li></ul></li><li></li><li><a href="Page.html">Page</a><ul class='methods'><li data-type='method'><a href="Page.html#bringToFront">bringToFront</a></li><li data-type='method'><a href="Page.html#browser">browser</a></li><li data-type='method'><a href="Page.html#build">build</a></li><li data-type='method'><a href="Page.html#canGoBack">canGoBack</a></li><li data-type='method'><a href="Page.html#canGoForward">canGoForward</a></li><li data-type='method'><a href="Page.html#close">close</a></li><li data-type='method'><a href="Page.html#cookies">cookies</a></li><li data-type='method'><a href="Page.html#deleteCookies">deleteCookies</a></li><li data-type='method'><a href="Page.html#evaluateHandle">evaluateHandle</a></li><li data-type='method'><a href="Page.html#find">find</a></li><li data-type='method'><a href="Page.html#frames">frames</a></li><li data-type='method'><a href="Page.html#goBack">goBack</a></li><li data-type='method'><a href="Page.html#goForward">goForward</a></li><li data-type='method'><a href="Page.html#init">init</a></li><li data-type='method'><a href="Page.html#isClosed">isClosed</a></li><li data-type='method'><a href="Page.html#isLoading">isLoading</a></li><li data-type='method'><a href="Page.html#isLoadingMainFrame">isLoadingMainFrame</a></li><li data-type='method'><a href="Page.html#mainFrame">mainFrame</a></li><li data-type='method'><a href="Page.html#queryObjects">queryObjects</a></li><li data-type='method'><a href="Page.html#reload">reload</a></li><li data-type='method'><a href="Page.html#screenshot">screenshot</a></li><li data-type='method'><a href="Page.html#setCookie">setCookie</a></li><li data-type='method'><a href="Page.html#waitForRequest">waitForRequest</a></li><li data-type='method'><a href="Page.html#waitForResponse">waitForResponse</a></li></ul></li><li></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">ipc.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file ipc通信类
 */
import util from './util.js'

const isDevelopment = process.env.NODE_ENV === 'development'
const ipcLog = process.env.ipcLog

// renderer to preload
const SEND_NAME = 'electron-puppeteer_r2p'
// preload to renderer
const RECEIVE_NAME = 'electron-puppeteer_p2r'
// ack prefix
const ACK_PREFIX = 'ack_r2p_'

/**
 * @class Ipc
 */
export default class Ipc {
	/**
	 * @constructor Ipc
	 */
	constructor(webview, options) {
		this.webview = webview
		this.options = options || {}
		this._hold = false
		this._holdTasks = []
		this._listeners = []
		// UUID -> routingId的映射
		this._routingIdMaps = new Map()
		this._bindEvent()

	}
	/**
	 * @typedef {Object} IpcEvent
	 * @property {string} UUID iframe的UUID, mainFrame为～，任意frame为*
	 * @property {string} name 消息名
	 * @property {string} ack 回执消息名
	 * @property {boolean} isMainFrame 是否为主页面
	 * @property {IpcEvent} originalEvent 原生事件
	 */
	/**
	 * @typedef {Function} IpcListener
	 * @param {IpcEvent} evt 消息对象
	 * @param {Object} payload 消息数据
	 */

	/**
	 * 绑定消息监听事件
	 * @private
	 */
	_bindEvent() {
		this.webview.addEventListener('ipc-message', (originalEvent) => {
			if (originalEvent.channel === RECEIVE_NAME) {
				let evt = originalEvent.args[0]
				evt.originalEvent = originalEvent

				
				if (evt.isAck) {
					isDevelopment &amp;&amp; ipcLog &amp;&amp; console.log('%cipc ack', 'font-weight:bold;color:green;', `name: ${evt.name},`, `UUID: ${evt.UUID},`, `payload: ${JSON.stringify(evt.payload)}`)
				} else {
					isDevelopment &amp;&amp; ipcLog &amp;&amp; console.log('%cipc receive', 'font-weight:bold;color:darkCyan;', `name: ${evt.name},`, `ack: ${evt.ack},`, `UUID: ${evt.UUID},`, `payload: ${JSON.stringify(evt.payload)}`)
				}

				if (!evt.isAck &amp;&amp; evt.UUID !== '*') {
					this._routingIdMaps.set(evt.UUID, evt.routingId)
				}
				
				let results = []
				for (let i = 0; i &lt; this._listeners.length; i++) {
					let item = this._listeners[i]
					if ((item.UUID === '*' || item.UUID === evt.UUID) &amp;&amp; item.name === evt.name &amp;&amp; !!item.isAck === !!evt.isAck) {
						let once = item.isAck &amp;&amp; item.once
						if (once) {
							this._listeners.splice(i--, 1)
						}
						results.push(item.listener.call(this.webview, evt.payload, evt))
						break
					}
				}
				
				// reply
				// 没有ack则认为不需要回复
				if (!evt.isAck &amp;&amp; evt.ack) {
					Promise.all(results).then(results => {
						this._sendAck(evt.UUID, evt.ack, results.shift(), evt.isMainFrame)
					})
				}
			}
		})

		// 页面跳转之前
		// hold住所有消息，等完成后再继续发送，否则会丢失
		this.webview.addEventListener('will-navigate', () => {
			this._hold = true
			isDevelopment &amp;&amp; ipcLog &amp;&amp; console.warn('%cipc hold', 'font-weight:bold;', this.webview)
		})

		// 页面ready后重新发送消息
		this.webview.addEventListener('dom-ready', () => {
			isDevelopment &amp;&amp; ipcLog &amp;&amp; console.warn('%cipc recover', 'font-weight:bold;', this.webview)
			this._hold = false
			this._runHoldTasks()
		})
	}
	_runHoldTasks() {
		while(this._holdTasks.length) {
			let task = this._holdTasks.shift()
			if (task.isAck) {
				this._sendAck(task.UUID, task.name, task.payload, task.isMainFrame)
			} else {
				this.send(task.UUID, task.name, task.payload, task.timeout).then(task.resolve, task.reject)
			}
		}
	}
	// 生成ack_name
	_generatorAckName(name) {
		return util.uniqueId(ACK_PREFIX + name + '_')
	}
	_sendAck(UUID, ack, result, isMainFrame) {
		if (this._hold) {
			this._holdTasks.push({
				UUID,
				name: ack,
				isAck: true,
				payload: result,
				isMainFrame: isMainFrame,
			})
		} else {
			isDevelopment &amp;&amp; ipcLog &amp;&amp; console.log('%cipc reply', 'font-weight:bold;color:#c59519', `name: ${ack},`, `UUID: ${UUID},`,  `result: ${JSON.stringify(result)}`)
			
			let sender = this._getSender(UUID)

			try {
				sender(SEND_NAME, {
					UUID,
					name: ack,
					ack: '',
					isAck: true,
					payload: result,
					isMainFrame: isMainFrame
				})
			} catch(e) {

			}
		}
	}
	_getSender(UUID) {
		switch (UUID) {
			// any 
			case '*':
				return (name, data) => {
					let sended = new Set()
					this._routingIdMaps.forEach(routingId => {
						if (!sended.has(routingId)) {
							sended.add(routingId)
							let webContents = this.webview.getWebContents()
							webContents.sendToFrame(routingId, name, data)
						}
					})
				}
			// mainFrame
			case '~':
				return this.webview.send.bind(this.webview)
			// other
			default:
				let routingId = this._routingIdMaps.get(UUID)
				if (!routingId) {
					console.error('ipc reply error, failed to map routingId')
					throw "ipc error"
				}
				let webContents = this.webview.getWebContents()
				return webContents.sendToFrame.bind(webContents, routingId)

		}
	}

	/**
	 * 给webview内的指定iframe发送消息
	 * @param {string} UUID iframe的UUID, mainFrame为～，任意frame为*
	 * @param {string|string[]} name 消息名, 支持合并发送payload相同的消息
	 * @param {Object} payload 传输数据
	 * @param {number} timeout 等待回复时间
	 * 
	 * @return {Promise&lt;IpcEvent>} 返回promise，等待消息回复内容
	 */
	send(UUID, name, payload, timeout) {
		if (Array.isArray(name)) {
			return Promise.all(name.map(item => this.send(item, payload, timeout)))
		}

		if (this._hold) {
			return new Promise((resolve, reject) => {
				this._holdTasks.push({
					resolve,
					reject,
					UUID,
					name,
					payload,
					timeout,
					isAck: false
				})
			})
		}

		timeout = timeout || this.options.timeout || 1e4
		let ack = this._generatorAckName(name)

		return new Promise((resolve, reject) => {
			// 收到回执信息，触发回调
			let onAck = (result) => {
				window.clearTimeout(timer)
				resolve(result)
			}
			// 放入监听队列
			this._listeners.push({
				UUID, 
				name: ack, 
				listener: onAck, 
				once: true,
				isAck: true,
			})
			// 超时判断
			let timer = window.setTimeout(() => {
				this.off(UUID, ack, onAck)
				reject('ipc.timeout')
			}, timeout)

			isDevelopment &amp;&amp; ipcLog &amp;&amp; console.log('%cipc send', 'font-weight:bold;color:#00f', `name: ${name},`, `ack: ${ack},`, `UUID: ${UUID},`, `payload: ${JSON.stringify(payload)}`)

			// 获取发送消息的sender
			let sender = this._getSender(UUID)
			// 发送消息
			sender(SEND_NAME, {
				UUID,
				name,
				ack,
				payload,
				isAck: false,
			})
		}).catch(err => {
			if (err === 'ipc.timeout') {
				isDevelopment &amp;&amp; ipcLog &amp;&amp; console.log('%cipc timeout', 'font-weight:bold;color:#f00', `name: ${name},`, `ack: ${ack},`, `UUID: ${UUID},`, `payload: ${JSON.stringify(payload)}`)
			} else {
				console.error('ipc send error:', err)
			}

			return Promise.reject(err)
		})
	}
	/**
	 * 当收到某消息时立即发送指定消息给发送方, 和ack不同
	 * @param {string} UUID iframe的UUID, mainFrame为～，任意frame为*
	 * @param {string} trigger 触发的消息名
	 * @param {string|string[]} name 消息名, 支持合并发送payload相同的消息
	 * @param {Object} payload 传输数据
	 */
	sendOn(UUID, trigger, name, payload) {
		this.on(UUID, trigger, () => {
			this.send(UUID, name, payload)
		})
	}
	/**
	 * 监听webview内iframe消息
	 * @param {string} UUID 消息来源iframe的UUID, mainFrame为～，任意frame为*
	 * @param {string} name 消息名
	 * @param {IpcListener} listener 响应函数
	 * 
	 * @return {Ipc} this
	 * 
	 */
	on(UUID, name, listener) {
		this._listeners.push({
			UUID,
			name,
			listener,
			once: false,
			isAck: false,
		})
		return this
	}
	/**
	 * 单次监听webview内的消息
	 * @param {string} UUID iframe的UUID, mainFrame为～，任意frame为*
	 * @param {string} name 消息名
	 * @param {IpcListener} listener 响应函数
	 * 
	 * @return {Ipc} this
	 * 
	 */
	once(UUID, name, listener) {
		this._listeners.push({
			UUID,
			name,
			listener,
			once: true,
			isAck: false,
		})
		return this
	}
	/**
	 * 取消监听
	 * @param {string} UUID iframe的UUID, mainFrame为～，任意frame为*
	 * @param {string} name 消息名
	 * @param {IpcListener} [listener] 响应函数
	 * @return {Ipc} this
	 */
	off(UUID, name, listener) {
		this._listeners = this._listeners.filter(item => {
			if (item.UUID === UUID &amp;&amp; item.name === name &amp;&amp; (!listener || item.listener === listener)) {
				return false
			}
			return true
		})
		return this
	}
}

const ipcPool = new WeakMap()

/**
 * 已绑定了UUID的ipc
 */
export class BoundIpc {
	static setOptions(options) {
		BoundIpc.options = options
	}
	constructor(webview, UUID) {
		this.UUID = UUID

		if (ipcPool.has(webview)) {
			this.executor = ipcPool.get(webview)
		} else {
			this.executor = new Ipc(webview, BoundIpc.options)
			ipcPool.set(webview, this.executor)
		}
	}
	/**
	 * 发送消息
	 * @param {string|string[]} name 消息名, 支持合并发送payload相同的消息
	 * @param {Object} payload 传输数据
	 * @param {number} timeout 等待回复时间
	 * 
	 * @return {Promise&lt;IpcEvent>} 返回promise，等待消息回复内容
	 */
	send(name, payload, timeout) {
		return this.executor.send(this.UUID, name, payload, timeout)
	}
	/**
	 * 当收到某消息时立即发送指定消息给发送方, 和ack不同
	 * @param {string} trigger 触发的消息名
	 * @param {string|string[]} name 消息名, 支持合并发送payload相同的消息
	 * @param {Object} payload 传输数据
	 * 
	 * @return {BoundIpc} this
	 */
	sendOn(trigger, name, payload) {
		this.executor.sendOn(this.UUID, trigger, name, payload)
		return this
	}
	/**
	 * 监听消息
	 * @param {string} name 消息名
	 * @param {IpcListener} listener 响应函数
	 * 
	 * @return {BoundIpc} this
	 * 
	 */
	on(name, listener) {
		this.executor.on(this.UUID, name, listener)
		return this
	}
	/**
	 * 单次监听webview内的消息
	 * @param {string} name 消息名
	 * @param {IpcListener} listener 响应函数
	 * 
	 * @return {BoundIpc} this
	 * 
	 */
	once(name, listener) {
		this.executor.once(this.UUID, name, listener)
		return this
	}
	/**
	 * 取消监听
	 * @param {string} name 消息名
	 * @param {IpcListener} listener 响应函数
	 * 
	 * @return {BoundIpc} this
	 * 
	 */
	off(name, listener) {
		this.executor.off(this.UUID, name, listener)
		return this
	}
}

// 聚合Ipc，可以收发多个ipc的消息
export class AggregateIpc {
	constructor() {
		this._ = new Set()
		this._onStack = []
		this._sendStack = []
	}
	/**
	 * 添加ipc实例，添加之前的所有send会在添加时发送，on也会在add时监听
	 * @param {Ipc}} ipc ipc实例
	 * @return {AggregateIpc} this
	 */
	add(ipc) {
		this._.add(ipc)
		this._onStack.forEach(item => {
			ipc.on(item[0], (payload, evt) => {
				item[1].call(null, payload, evt, ipc)
			})
		})
		this._sendStack.forEach(item => {
			ipc.send.apply(ipc, item)
		})
		return this
	}
	/**
	 * 删除ipc实例
	 * @param {Ipc}} ipc ipc实例
	 * @return {AggregateIpc} this
	 */
	delete(ipc) {
		this._.delete(ipc)
		return this
	}
	/**
	 * 清空ipc实例
	 * @return {AggregateIpc} this
	 */
	clear() {
		this._.clear()
		return this
	}
	/**
	 * 监听消息
	 * @param {string} name 消息名
	 * @param {IpcListener} listener 响应函数
	 * 
	 * @return {AggregateIpc} this
	 * 
	 */
	on(name, listener) {
		this._onStack.push([name, listener])
		this._.forEach(ipc => {
			ipc.on(name, (payload, evt) => {
				listener.call(null, payload, evt, ipc)
			})
		})
		return this
	}
	/**
	 * 取消监听消息
	 * @param {string} name 消息名
	 * @param {IpcListener} [listener] 响应函数
	 * 
	 * @return {AggregateIpc} this
	 * 
	 */
	off(name, listener) {
		this._onStack = this._onStack.filter(item => {
			if (item[0] === name &amp;&amp; (!listener || item[1] === listener)) {
				return false
			}
			return true
		})
		this._.forEach(ipc => {
			ipc.off(name, listener)
		})
		return this
	}
	/**
	 * 发送消息
	 * @param {string} name 消息名
	 * @param {Object} payload 传输数据
	 * 
	 * @return {AggregateIpc} this
	 * 
	 */
	send(name, payload) {
		this._sendStack.push([name, payload])
		this._.forEach(ipc => {
			ipc.send(name, payload)
		})

		return this
	}
	/**
	 * 当收到某消息时立即发送指定消息给发送方
	 * @param {string} trigger 触发的消息名
	 * @param {string} name 消息名
	 * @param {Object} payload 传输数据
	 * 
	 * @return {AggregateIpc} this
	 */
	sendOn(trigger, name, payload) {
		this.on(trigger, (data, evt, ipc) => {
			console.log('sendOn', trigger, name, payload)
			ipc.send(name, payload)
		})

		return this
	}
}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Fri May 08 2020 20:40:12 GMT+0800 (GMT+08:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
