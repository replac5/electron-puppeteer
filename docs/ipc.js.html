<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>ipc.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Browser.html">Browser</a><ul class='methods'><li data-type='method'><a href="Browser.html#init">init</a></li><li data-type='method'><a href="Browser.html#getBoundingClientRect">getBoundingClientRect</a></li><li data-type='method'><a href="Browser.html#build">build</a></li><li data-type='method'><a href="Browser.html#_handleWindowPage">_handleWindowPage</a></li><li data-type='method'><a href="Browser.html#bringToFront">bringToFront</a></li><li data-type='method'><a href="Browser.html#close">close</a></li><li data-type='method'><a href="Browser.html#pages">pages</a></li><li data-type='method'><a href="Browser.html#getPageById">getPageById</a></li><li data-type='method'><a href="Browser.html#frontPage">frontPage</a></li><li data-type='method'><a href="Browser.html#newPage">newPage</a></li><li data-type='method'><a href="Browser.html#_setCtrlIcons">_setCtrlIcons</a></li><li data-type='method'><a href="Browser.html#_newPageWithoutReady">_newPageWithoutReady</a></li></ul></li><li></li><li><a href="BrowserManager.html">BrowserManager</a><ul class='methods'><li data-type='method'><a href="BrowserManager.html#launch">launch</a></li><li data-type='method'><a href="BrowserManager.html#getEarliest">getEarliest</a></li><li data-type='method'><a href="BrowserManager.html#get">get</a></li><li data-type='method'><a href="BrowserManager.html#frontBrowser">frontBrowser</a></li></ul></li><li></li><li><a href="ElementHandle.html">ElementHandle</a><ul class='methods'><li data-type='method'><a href="ElementHandle.html#$">$</a></li><li data-type='method'><a href="ElementHandle.html#$$">$$</a></li><li data-type='method'><a href="ElementHandle.html#$eval">$eval</a></li><li data-type='method'><a href="ElementHandle.html#$$eval">$$eval</a></li><li data-type='method'><a href="ElementHandle.html#$x">$x</a></li><li data-type='method'><a href="ElementHandle.html#asElement">asElement</a></li><li data-type='method'><a href="ElementHandle.html#boundingBox">boundingBox</a></li><li data-type='method'><a href="ElementHandle.html#textContent">textContent</a></li><li data-type='method'><a href="ElementHandle.html#boxModel">boxModel</a></li><li data-type='method'><a href="ElementHandle.html#click">click</a></li><li data-type='method'><a href="ElementHandle.html#show">show</a></li><li data-type='method'><a href="ElementHandle.html#hide">hide</a></li><li data-type='method'><a href="ElementHandle.html#contentFrame">contentFrame</a></li><li data-type='method'><a href="ElementHandle.html#dispose">dispose</a></li><li data-type='method'><a href="ElementHandle.html#executionContext">executionContext</a></li><li data-type='method'><a href="ElementHandle.html#check">check</a></li><li data-type='method'><a href="ElementHandle.html#uncheck">uncheck</a></li><li data-type='method'><a href="ElementHandle.html#getProperties">getProperties</a></li><li data-type='method'><a href="ElementHandle.html#getProperty">getProperty</a></li><li data-type='method'><a href="ElementHandle.html#focus">focus</a></li><li data-type='method'><a href="ElementHandle.html#blur">blur</a></li><li data-type='method'><a href="ElementHandle.html#getAttributes">getAttributes</a></li><li data-type='method'><a href="ElementHandle.html#getAttribute">getAttribute</a></li><li data-type='method'><a href="ElementHandle.html#hover">hover</a></li><li data-type='method'><a href="ElementHandle.html#isIntersectingViewport">isIntersectingViewport</a></li><li data-type='method'><a href="ElementHandle.html#jsonValue">jsonValue</a></li><li data-type='method'><a href="ElementHandle.html#press">press</a></li><li data-type='method'><a href="ElementHandle.html#screenshot">screenshot</a></li><li data-type='method'><a href="ElementHandle.html#tap">tap</a></li><li data-type='method'><a href="ElementHandle.html#toString">toString</a></li><li data-type='method'><a href="ElementHandle.html#type">type</a></li><li data-type='method'><a href="ElementHandle.html#uploadFile">uploadFile</a></li></ul></li><li></li><li><a href="EventEmitter.html">EventEmitter</a><ul class='methods'><li data-type='method'><a href="EventEmitter.html#.noConflict">noConflict</a></li></ul></li><li><a href="Frame.html">Frame</a><ul class='methods'><li data-type='method'><a href="Frame.html#addScriptTag">addScriptTag</a></li><li data-type='method'><a href="Frame.html#addStyleTag">addStyleTag</a></li><li data-type='method'><a href="Frame.html#childFrames">childFrames</a></li><li data-type='method'><a href="Frame.html#content">content</a></li><li data-type='method'><a href="Frame.html#evaluate">evaluate</a></li><li data-type='method'><a href="Frame.html#goto">goto</a></li><li data-type='method'><a href="Frame.html#isDetached">isDetached</a></li><li data-type='method'><a href="Frame.html#name">name</a></li><li data-type='method'><a href="Frame.html#page">page</a></li><li data-type='method'><a href="Frame.html#parentFrame">parentFrame</a></li><li data-type='method'><a href="Frame.html#select">select</a></li><li data-type='method'><a href="Frame.html#setContent">setContent</a></li><li data-type='method'><a href="Frame.html#title">title</a></li><li data-type='method'><a href="Frame.html#type">type</a></li><li data-type='method'><a href="Frame.html#press">press</a></li><li data-type='method'><a href="Frame.html#url">url</a></li><li data-type='method'><a href="Frame.html#waitFor">waitFor</a></li><li data-type='method'><a href="Frame.html#waitForFunction">waitForFunction</a></li><li data-type='method'><a href="Frame.html#waitForNavigation">waitForNavigation</a></li><li data-type='method'><a href="Frame.html#waitForNavigationOut">waitForNavigationOut</a></li><li data-type='method'><a href="Frame.html#waitForNavigationTo">waitForNavigationTo</a></li><li data-type='method'><a href="Frame.html#waitForSelector">waitForSelector</a></li><li data-type='method'><a href="Frame.html#hasElement">hasElement</a></li><li data-type='method'><a href="Frame.html#waitForXPath">waitForXPath</a></li><li data-type='method'><a href="Frame.html#click">click</a></li><li data-type='method'><a href="Frame.html#focus">focus</a></li><li data-type='method'><a href="Frame.html#blur">blur</a></li><li data-type='method'><a href="Frame.html#hover">hover</a></li><li data-type='method'><a href="Frame.html#tap">tap</a></li><li data-type='method'><a href="Frame.html#localStorageKeys">localStorageKeys</a></li><li data-type='method'><a href="Frame.html#localStorageGet">localStorageGet</a></li><li data-type='method'><a href="Frame.html#localStorageSet">localStorageSet</a></li><li data-type='method'><a href="Frame.html#localStorageRemove">localStorageRemove</a></li><li data-type='method'><a href="Frame.html#$">$</a></li><li data-type='method'><a href="Frame.html#$$">$$</a></li><li data-type='method'><a href="Frame.html#$eval">$eval</a></li><li data-type='method'><a href="Frame.html#$$eval">$$eval</a></li><li data-type='method'><a href="Frame.html#$x">$x</a></li></ul></li><li></li><li><a href="Page.html">Page</a><ul class='methods'><li data-type='method'><a href="Page.html#init">init</a></li><li data-type='method'><a href="Page.html#build">build</a></li><li data-type='method'><a href="Page.html#isLoading">isLoading</a></li><li data-type='method'><a href="Page.html#isLoadingMainFrame">isLoadingMainFrame</a></li><li data-type='method'><a href="Page.html#bringToFront">bringToFront</a></li><li data-type='method'><a href="Page.html#browser">browser</a></li><li data-type='method'><a href="Page.html#close">close</a></li><li data-type='method'><a href="Page.html#cookie">cookie</a></li><li data-type='method'><a href="Page.html#cookies">cookies</a></li><li data-type='method'><a href="Page.html#deleteCookies">deleteCookies</a></li><li data-type='method'><a href="Page.html#frames">frames</a></li><li data-type='method'><a href="Page.html#canGoBack">canGoBack</a></li><li data-type='method'><a href="Page.html#canGoForward">canGoForward</a></li><li data-type='method'><a href="Page.html#goBack">goBack</a></li><li data-type='method'><a href="Page.html#goForward">goForward</a></li><li data-type='method'><a href="Page.html#isClosed">isClosed</a></li><li data-type='method'><a href="Page.html#mainFrame">mainFrame</a></li><li data-type='method'><a href="Page.html#find">find</a></li><li data-type='method'><a href="Page.html#reload">reload</a></li><li data-type='method'><a href="Page.html#screenshot">screenshot</a></li><li data-type='method'><a href="Page.html#setCookie">setCookie</a></li><li data-type='method'><a href="Page.html#clearHistory">clearHistory</a></li><li data-type='method'><a href="Page.html#waitForRequest">waitForRequest</a></li><li data-type='method'><a href="Page.html#waitForResponse">waitForResponse</a></li><li data-type='method'><a href="Page.html#evaluateHandle">evaluateHandle</a></li><li data-type='method'><a href="Page.html#queryObjects">queryObjects</a></li><li data-type='method'><a href="Page.html#target">target</a></li><li data-type='method'><a href="Page.html#_initWindowProxy">_initWindowProxy</a></li><li data-type='method'><a href="Page.html#$">$</a></li><li data-type='method'><a href="Page.html#$$">$$</a></li><li data-type='method'><a href="Page.html#$eval">$eval</a></li><li data-type='method'><a href="Page.html#$$eval">$$eval</a></li><li data-type='method'><a href="Page.html#$x">$x</a></li><li data-type='method'><a href="Page.html#addScriptTag">addScriptTag</a></li><li data-type='method'><a href="Page.html#addStyleTag">addStyleTag</a></li><li data-type='method'><a href="Page.html#click">click</a></li><li data-type='method'><a href="Page.html#content">content</a></li><li data-type='method'><a href="Page.html#evaluate">evaluate</a></li><li data-type='method'><a href="Page.html#focus">focus</a></li><li data-type='method'><a href="Page.html#hover">hover</a></li><li data-type='method'><a href="Page.html#goto">goto</a></li><li data-type='method'><a href="Page.html#select">select</a></li><li data-type='method'><a href="Page.html#setContent">setContent</a></li><li data-type='method'><a href="Page.html#tap">tap</a></li><li data-type='method'><a href="Page.html#title">title</a></li><li data-type='method'><a href="Page.html#type">type</a></li><li data-type='method'><a href="Page.html#press">press</a></li><li data-type='method'><a href="Page.html#url">url</a></li><li data-type='method'><a href="Page.html#waitFor">waitFor</a></li><li data-type='method'><a href="Page.html#waitForFunction">waitForFunction</a></li><li data-type='method'><a href="Page.html#waitForNavigation">waitForNavigation</a></li><li data-type='method'><a href="Page.html#waitForNavigationOut">waitForNavigationOut</a></li><li data-type='method'><a href="Page.html#waitForNavigationTo">waitForNavigationTo</a></li><li data-type='method'><a href="Page.html#waitForSelector">waitForSelector</a></li><li data-type='method'><a href="Page.html#hasElement">hasElement</a></li><li data-type='method'><a href="Page.html#waitForXPath">waitForXPath</a></li><li data-type='method'><a href="Page.html#localStorageKeys">localStorageKeys</a></li><li data-type='method'><a href="Page.html#localStorageGet">localStorageGet</a></li><li data-type='method'><a href="Page.html#localStorageSet">localStorageSet</a></li><li data-type='method'><a href="Page.html#localStorageRemove">localStorageRemove</a></li></ul></li><li></li><li><a href="WindowPage.html">WindowPage</a><ul class='methods'><li data-type='method'><a href="WindowPage.html#init">init</a></li><li data-type='method'><a href="WindowPage.html#build">build</a></li><li data-type='method'><a href="WindowPage.html#isLoading">isLoading</a></li><li data-type='method'><a href="WindowPage.html#isLoadingMainFrame">isLoadingMainFrame</a></li><li data-type='method'><a href="WindowPage.html#bringToFront">bringToFront</a></li><li data-type='method'><a href="WindowPage.html#browser">browser</a></li><li data-type='method'><a href="WindowPage.html#close">close</a></li><li data-type='method'><a href="WindowPage.html#cookie">cookie</a></li><li data-type='method'><a href="WindowPage.html#cookies">cookies</a></li><li data-type='method'><a href="WindowPage.html#deleteCookies">deleteCookies</a></li><li data-type='method'><a href="WindowPage.html#frames">frames</a></li><li data-type='method'><a href="WindowPage.html#canGoBack">canGoBack</a></li><li data-type='method'><a href="WindowPage.html#canGoForward">canGoForward</a></li><li data-type='method'><a href="WindowPage.html#goBack">goBack</a></li><li data-type='method'><a href="WindowPage.html#goForward">goForward</a></li><li data-type='method'><a href="WindowPage.html#isClosed">isClosed</a></li><li data-type='method'><a href="WindowPage.html#mainFrame">mainFrame</a></li><li data-type='method'><a href="WindowPage.html#find">find</a></li><li data-type='method'><a href="WindowPage.html#reload">reload</a></li><li data-type='method'><a href="WindowPage.html#screenshot">screenshot</a></li><li data-type='method'><a href="WindowPage.html#setCookie">setCookie</a></li><li data-type='method'><a href="WindowPage.html#clearHistory">clearHistory</a></li><li data-type='method'><a href="WindowPage.html#waitForRequest">waitForRequest</a></li><li data-type='method'><a href="WindowPage.html#waitForResponse">waitForResponse</a></li><li data-type='method'><a href="WindowPage.html#evaluateHandle">evaluateHandle</a></li><li data-type='method'><a href="WindowPage.html#queryObjects">queryObjects</a></li><li data-type='method'><a href="WindowPage.html#target">target</a></li><li data-type='method'><a href="WindowPage.html#_initWindowProxy">_initWindowProxy</a></li><li data-type='method'><a href="WindowPage.html#$">$</a></li><li data-type='method'><a href="WindowPage.html#$$">$$</a></li><li data-type='method'><a href="WindowPage.html#$eval">$eval</a></li><li data-type='method'><a href="WindowPage.html#$$eval">$$eval</a></li><li data-type='method'><a href="WindowPage.html#$x">$x</a></li><li data-type='method'><a href="WindowPage.html#addScriptTag">addScriptTag</a></li><li data-type='method'><a href="WindowPage.html#addStyleTag">addStyleTag</a></li><li data-type='method'><a href="WindowPage.html#click">click</a></li><li data-type='method'><a href="WindowPage.html#content">content</a></li><li data-type='method'><a href="WindowPage.html#evaluate">evaluate</a></li><li data-type='method'><a href="WindowPage.html#focus">focus</a></li><li data-type='method'><a href="WindowPage.html#hover">hover</a></li><li data-type='method'><a href="WindowPage.html#goto">goto</a></li><li data-type='method'><a href="WindowPage.html#select">select</a></li><li data-type='method'><a href="WindowPage.html#setContent">setContent</a></li><li data-type='method'><a href="WindowPage.html#tap">tap</a></li><li data-type='method'><a href="WindowPage.html#title">title</a></li><li data-type='method'><a href="WindowPage.html#type">type</a></li><li data-type='method'><a href="WindowPage.html#press">press</a></li><li data-type='method'><a href="WindowPage.html#url">url</a></li><li data-type='method'><a href="WindowPage.html#waitFor">waitFor</a></li><li data-type='method'><a href="WindowPage.html#waitForFunction">waitForFunction</a></li><li data-type='method'><a href="WindowPage.html#waitForNavigation">waitForNavigation</a></li><li data-type='method'><a href="WindowPage.html#waitForNavigationOut">waitForNavigationOut</a></li><li data-type='method'><a href="WindowPage.html#waitForNavigationTo">waitForNavigationTo</a></li><li data-type='method'><a href="WindowPage.html#waitForSelector">waitForSelector</a></li><li data-type='method'><a href="WindowPage.html#hasElement">hasElement</a></li><li data-type='method'><a href="WindowPage.html#waitForXPath">waitForXPath</a></li><li data-type='method'><a href="WindowPage.html#localStorageKeys">localStorageKeys</a></li><li data-type='method'><a href="WindowPage.html#localStorageGet">localStorageGet</a></li><li data-type='method'><a href="WindowPage.html#localStorageSet">localStorageSet</a></li><li data-type='method'><a href="WindowPage.html#localStorageRemove">localStorageRemove</a></li></ul></li><li><a href="Target.html">Target</a><ul class='methods'><li data-type='method'><a href="Target.html#browser">browser</a></li><li data-type='method'><a href="Target.html#opener">opener</a></li><li data-type='method'><a href="Target.html#page">page</a></li><li data-type='method'><a href="Target.html#type">type</a></li><li data-type='method'><a href="Target.html#url">url</a></li></ul></li><li></li><li><a href="Ipc.html">Ipc</a><ul class='methods'><li data-type='method'><a href="Ipc.html#send">send</a></li><li data-type='method'><a href="Ipc.html#sendOn">sendOn</a></li><li data-type='method'><a href="Ipc.html#on">on</a></li><li data-type='method'><a href="Ipc.html#once">once</a></li><li data-type='method'><a href="Ipc.html#off">off</a></li><li data-type='method'><a href="Ipc.html#dispatch">dispatch</a></li></ul></li><li></li><li><a href="BoundIpc.html">BoundIpc</a><ul class='methods'><li data-type='method'><a href="BoundIpc.html#send">send</a></li><li data-type='method'><a href="BoundIpc.html#sendOn">sendOn</a></li><li data-type='method'><a href="BoundIpc.html#on">on</a></li><li data-type='method'><a href="BoundIpc.html#once">once</a></li><li data-type='method'><a href="BoundIpc.html#off">off</a></li><li data-type='method'><a href="BoundIpc.html#dispatch">dispatch</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="Browser.html#event:back">back</a></li><li><a href="Browser.html#event:front">front</a></li><li><a href="Browser.html#event:close">close</a></li><li><a href="Browser.html#event:new-page">new-page</a></li><li><a href="Browser.html#event:targetcreated">targetcreated</a></li><li><a href="Browser.html#event:targetchanged">targetchanged</a></li><li><a href="Browser.html#event:targetdestroyed">targetdestroyed</a></li><li><a href="Page.html#event:dom-event">dom-event</a></li><li><a href="Page.html#event:frameattached">frameattached</a></li><li><a href="Page.html#event:framenavigated">framenavigated</a></li><li><a href="Page.html#event:connect">connect</a></li><li><a href="Page.html#event:framedetached">framedetached</a></li><li><a href="Page.html#event:disconnect">disconnect</a></li><li><a href="Page.html#event:load-start">load-start</a></li><li><a href="Page.html#event:load-fail">load-fail</a></li><li><a href="Page.html#event:load-end">load-end</a></li><li><a href="Page.html#event:title-updated">title-updated</a></li><li><a href="Page.html#event:favicon-updated">favicon-updated</a></li><li><a href="Page.html#event:console">console</a></li><li><a href="Page.html#event:new-window">new-window</a></li><li><a href="Page.html#event:will-navigate">will-navigate</a></li><li><a href="Page.html#event:dom-ready">dom-ready</a></li><li><a href="Page.html#event:load">load</a></li><li><a href="Page.html#event:domcontentloaded">domcontentloaded</a></li><li><a href="Page.html#event:historyNavigation">historyNavigation</a></li><li><a href="Page.html#event:hashchange">hashchange</a></li><li></li><li><a href="Page.html#event:back">back</a></li><li><a href="Page.html#event:front">front</a></li><li><a href="Page.html#event:close">close</a></li><li><a href="WindowPage.html#event:dom-event">dom-event</a></li><li><a href="WindowPage.html#event:frameattached">frameattached</a></li><li><a href="WindowPage.html#event:framenavigated">framenavigated</a></li><li><a href="WindowPage.html#event:connect">connect</a></li><li><a href="WindowPage.html#event:framedetached">framedetached</a></li><li><a href="WindowPage.html#event:disconnect">disconnect</a></li><li><a href="WindowPage.html#event:load-start">load-start</a></li><li><a href="WindowPage.html#event:load-fail">load-fail</a></li><li><a href="WindowPage.html#event:load-end">load-end</a></li><li><a href="WindowPage.html#event:title-updated">title-updated</a></li><li><a href="WindowPage.html#event:favicon-updated">favicon-updated</a></li><li><a href="WindowPage.html#event:console">console</a></li><li><a href="WindowPage.html#event:new-window">new-window</a></li><li><a href="WindowPage.html#event:will-navigate">will-navigate</a></li><li><a href="WindowPage.html#event:dom-ready">dom-ready</a></li><li><a href="WindowPage.html#event:load">load</a></li><li><a href="WindowPage.html#event:domcontentloaded">domcontentloaded</a></li><li><a href="WindowPage.html#event:historyNavigation">historyNavigation</a></li><li><a href="WindowPage.html#event:hashchange">hashchange</a></li><li><a href="WindowPage.html#event:back">back</a></li><li><a href="WindowPage.html#event:front">front</a></li><li><a href="WindowPage.html#event:close">close</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_onRequestPaused">_onRequestPaused</a></li><li><a href="global.html#_onRequest">_onRequest</a></li><li><a href="global.html#_onRequestServedFromCache">_onRequestServedFromCache</a></li><li><a href="global.html#setCacheEnabled">setCacheEnabled</a></li><li><a href="global.html#setRequestInterception">setRequestInterception</a></li><li><a href="global.html#headersArray">headersArray</a></li><li><a href="global.html#urlMatch">urlMatch</a></li><li><a href="global.html#reqUpdater">reqUpdater</a></li><li><a href="global.html#resUpdater">resUpdater</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">ipc.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file ipc通信类
 */
const {remote} = require("electron")
import util from "./util.js"

const isDevelopment = process.env.NODE_ENV === "development"
const ipcLog = process.env.ipcLog

// renderer to preload
const SEND_NAME = "electron-puppeteer_r2p"
// preload to renderer
const RECEIVE_NAME = "electron-puppeteer_p2r"
// ack prefix
const ACK_PREFIX = "ack_r2p_"
// browserWindow connect
export const BROWSER_WINDOW_PAGE_CONNECT = "electron-puppeteer_page_connect"

/**
 * @class Ipc
 */
export default class Ipc {
  /**
   * @constructor Ipc
   */
  constructor(webview, options) {
    this.webview = webview
    this.options = options || {}
    this._hold = false
    this._destroyed = false
    this._holdTasks = []
    this._listeners = []
    // UUID -> routingId的映射
    this._routingIdMaps = new Map()
    this._bindEvent()
  }
  /**
   * @typedef {Object} IpcEvent
   * @property {string} UUID iframe的UUID, mainFrame为～，任意frame为*
   * @property {string} name 消息名
   * @property {string} ack 回执消息名
   * @property {boolean} isMainFrame 是否为主页面
   * @property {IpcEvent} originalEvent 原生事件
   */
  /**
   * @typedef {Function} IpcListener
   * @param {IpcEvent} evt 消息对象
   * @param {Object} payload 消息数据
   */

  /**
   * 绑定消息监听事件
   * @private
   */
  _bindEvent() {
    this.webview.addEventListener("ipc-message", (originalEvent) => {
      if (originalEvent.channel === RECEIVE_NAME) {
        let evt = originalEvent.args[0]
        evt.originalEvent = originalEvent
        this._handleMessageEvent(evt)
      }
    })

    // 页面跳转之前
    // hold住所有消息，等完成后再继续发送，否则会丢失
    this.webview.addEventListener("will-navigate", () => {
      this._hold = true
      isDevelopment &amp;&amp;
        ipcLog &amp;&amp;
        console.warn("%cipc hold", "font-weight:bold;", this.webview)
    })

    const onRecover = () => {
      if (this._hold) {
        isDevelopment &amp;&amp;
          ipcLog &amp;&amp;
          console.warn("%cipc recover", "font-weight:bold;", this.webview)
        this._hold = false
        this._runHoldTasks()
      }
    }

    // 页面ready后重新发送消息
    this.webview.addEventListener("dom-ready", onRecover)

    this.webview.addEventListener("close", () => {
      this._destroyed = true
    })
    this.webview.addEventListener("destroyed", () => {
      this._destroyed = true
    })
  }
  _handleMessageEvent(evt) {
    if (evt.isAck) {
      isDevelopment &amp;&amp;
        ipcLog &amp;&amp;
        console.log(
          "%cipc ack",
          "font-weight:bold;color:green;",
          `name: ${evt.name},`,
          `UUID: ${evt.UUID},`,
          `payload: ${JSON.stringify(evt.payload)}`
        )
    } else {
      isDevelopment &amp;&amp;
        ipcLog &amp;&amp;
        console.log(
          "%cipc receive",
          "font-weight:bold;color:darkCyan;",
          `name: ${evt.name},`,
          `ack: ${evt.ack},`,
          `UUID: ${evt.UUID},`,
          `payload: ${JSON.stringify(evt.payload)}`
        )
    }

    if (!evt.isAck &amp;&amp; evt.UUID !== "*") {
      this._routingIdMaps.set(evt.UUID, evt.routingId)
    }

    let results = []
    for (let i = 0; i &lt; this._listeners.length; i++) {
      let item = this._listeners[i]
      if (
        (item.UUID === "*" || item.UUID === evt.UUID) &amp;&amp;
        [].concat(item.name).indexOf(evt.name) > -1 &amp;&amp;
        !!item.isAck === !!evt.isAck
      ) {
        let once = item.isAck || item.once
        results.push(
          item.listener.call(this.webview, evt.payload, evt, evt.error)
        )
        if (once) {
          this._listeners.splice(i--, 1)
        }
        // ack是唯一的，无需往后匹配
        if (item.isAck) {
          break
        }
      }
    }

    // reply
    // 没有ack则认为不需要回复
    if (!evt.isAck &amp;&amp; evt.ack) {
      Promise.race(results.slice(0, 1)).then(
        (result) => {
          this._sendAck(evt.UUID, evt.ack, null, result, evt.isMainFrame)
        },
        (err) => {
          this._sendAck(
            evt.UUID,
            evt.ack,
            (err &amp;&amp; err.toString()) || "-",
            null,
            evt.isMainFrame
          )
        }
      )
    }

    return results
  }
  _runHoldTasks() {
    while (this._holdTasks.length) {
      let task = this._holdTasks.shift()
      if (task.isAck) {
        this._sendAck(
          task.UUID,
          task.name,
          task.error,
          task.payload,
          task.isMainFrame
        )
      } else {
        this.send(
          task.UUID,
          task.name,
          task.payload,
          task.timeout,
          task.retry
        ).then(task.resolve, task.reject)
      }
    }
  }
  // 生成ack_name
  _generatorAckName(name) {
    return util.uniqueId(ACK_PREFIX + name + "_")
  }
  _sendAck(UUID, ack, err, payload, isMainFrame) {
    if (this._destroyed) {
      return false
    }
    if (this._hold) {
      this._holdTasks.push({
        UUID,
        name: ack,
        isAck: true,
        error: err,
        payload: payload,
        isMainFrame: isMainFrame,
      })
    } else {
      isDevelopment &amp;&amp;
        ipcLog &amp;&amp;
        console.log(
          "%cipc reply",
          "font-weight:bold;color:#c59519",
          `name: ${ack},`,
          `UUID: ${UUID},`,
          `result: ${JSON.stringify(payload)}`
        )

      let sender = this._getSender(UUID)
      if (sender) {
        try {
          sender(SEND_NAME, {
            UUID,
            name: ack,
            ack: "",
            error: err,
            isAck: true,
            payload: payload,
            isMainFrame: isMainFrame,
          })
        } catch (e) {}
      }
    }
  }
  _isWebviewInDocument() {
    return (
      (this.webview.isDestroyed &amp;&amp; !this.webview.isDestroyed()) ||
      (this.webview.ownerDocument &amp;&amp;
        this.webview.ownerDocument.contains(this.webview))
    )
  }
  _getSender(UUID) {
    if (!this._isWebviewInDocument()) {
      return null
    }

    switch (UUID) {
      // any
      case "*":
        return (name, data) => {
          let sended = new Set()
          this._routingIdMaps.forEach((routingId) => {
            if (!sended.has(routingId)) {
              sended.add(routingId)
              let contentsId = this.webview.getWebContentsId()
              let contents = remote.webContents.fromId(contentsId)
              contents.sendToFrame(routingId, name, data)
            }
          })
        }
      // mainFrame
      case "~":
        return this.webview.send.bind(this.webview)
      // other
      default:
        let routingId = this._routingIdMaps.get(UUID)
        if (!routingId) {
          console.error("ipc reply error, failed to map routingId")
          throw "ipc error"
        }
        let contentsId = this.webview.getWebContentsId()
        let contents = remote.webContents.fromId(contentsId)
        return contents.sendToFrame.bind(contents, routingId)
    }
  }

  /**
   * 给webview内的指定iframe发送消息
   * @param {string} UUID iframe的UUID, mainFrame为～，任意frame为*
   * @param {string|string[]} name 消息名, 支持合并发送payload相同的消息
   * @param {Object} payload 传输数据
   * @param {number} timeout 等待回复时间
   * @param {number} retry 重试次数，默认不重试，仅在超时的情况才会重试
   *
   * @return {Promise&lt;IpcEvent>} 返回promise，等待消息回复内容
   */
  send(UUID, name, payload, timeout, retry) {
    if (this._destroyed) {
      return Promise.reject("ipc webview destroyed")
    }

    if (Array.isArray(name)) {
      return Promise.all(
        name.map((item) => this.send(item, payload, timeout, retry))
      )
    }

    if (this._hold) {
      return new Promise((resolve, reject) => {
        this._holdTasks.push({
          resolve,
          reject,
          UUID,
          name,
          payload,
          timeout,
          retry,
          isAck: false,
        })
      })
    }

    timeout = timeout || this.options.timeout || 1e4
    let ack = this._generatorAckName(name)

    return new Promise((resolve, reject) => {
      // 收到回执信息，触发回调
      let onAck = (result, evt) => {
        window.clearTimeout(timer)
        if (evt.error) {
          return reject(evt.error)
        }
        resolve(result)
      }
      // 放入监听队列
      this._listeners.push({
        UUID,
        name: ack,
        listener: onAck,
        once: true,
        isAck: true,
      })
      // 超时判断
      let timer = window.setTimeout(() => {
        this.off(UUID, ack, onAck)
        let payloadString = JSON.stringify(payload)
        if (payloadString.length > 200) {
          payloadString = payloadString.substr(0, 200) + "..."
        }
        reject(`ipc.timeout.send: ${name}@${UUID}, payload: ${payloadString}`)
      }, timeout)

      retry = retry || 0

      isDevelopment &amp;&amp;
        ipcLog &amp;&amp;
        console.log(
          "%cipc send",
          "font-weight:bold;color:#00f",
          `name: ${name},`,
          `ack: ${ack},`,
          `UUID: ${UUID},`,
          `payload: ${JSON.stringify(payload)}`
        )

      // 获取发送消息的sender
      let sender = this._getSender(UUID)
      if (sender) {
        // 发送消息
        sender(SEND_NAME, {
          UUID,
          name,
          ack,
          payload,
          isAck: false,
        })
      }
    }).catch((err) => {
      if (typeof err === "string" &amp;&amp; err.startsWith("ipc.timeout")) {
        isDevelopment &amp;&amp;
          ipcLog &amp;&amp;
          console.log(
            "%cipc timeout",
            "font-weight:bold;color:#f00",
            `name: ${name},`,
            `ack: ${ack},`,
            `UUID: ${UUID},`,
            `payload: ${JSON.stringify(payload)}`
          )
      } else {
        // console.error("ipc send error:", err)
      }

      if (--retry >= 0) {
        return this.send(UUID, name, payload, timeout, retry)
      }

      return Promise.reject(err)
    })
  }
  /**
   * 当收到某消息时立即发送指定消息给发送方, 和ack不同
   * @param {string} UUID iframe的UUID, mainFrame为～，任意frame为*
   * @param {string} trigger 触发的消息名
   * @param {string|string[]} name 消息名, 支持合并发送payload相同的消息
   * @param {Object} payload 传输数据
   */
  sendOn(UUID, trigger, name, payload) {
    this.on(UUID, trigger, () => {
      this.send(UUID, name, payload)
    })
  }
  /**
   * 监听webview内iframe消息
   * @param {string} UUID 消息来源iframe的UUID, mainFrame为～，任意frame为*
   * @param {string|string[]} name 消息名
   * @param {IpcListener} listener 响应函数
   * @param {boolean} unique 同名消息只绑定一次, 再次绑定时会取消前一次的绑定
   *
   * @return {Ipc} this
   *
   */
  on(UUID, name, listener, unique) {
    if (unique) {
      this.off(UUID, name)
    }

    this._listeners.push({
      UUID,
      name,
      listener,
      once: false,
      isAck: false,
    })
    return this
  }
  /**
   * 单次监听webview内的消息
   * @param {string} UUID iframe的UUID, mainFrame为～，任意frame为*
   * @param {string|string[]} name 消息名
   * @param {IpcListener} listener 响应函数
   *
   * @return {Ipc} this
   *
   */
  once(UUID, name, listener) {
    this._listeners.push({
      UUID,
      name,
      listener,
      once: true,
      isAck: false,
    })
    return this
  }
  /**
   * 取消监听
   * @param {string} UUID iframe的UUID, mainFrame为～，任意frame为*
   * @param {string|string[]} name 消息名
   * @param {IpcListener} [listener] 响应函数
   * @return {Ipc} this
   */
  off(UUID, name, listener) {
    this._listeners = this._listeners.filter((item) => {
      if (
        item.UUID === UUID &amp;&amp;
        item.name.toString() === name.toString() &amp;&amp;
        (!listener || item.listener === listener)
      ) {
        return false
      }
      return true
    })
    return this
  }
  /**
   * 模拟触发消息
   * @param {string} UUID iframe的UUID, mainFrame为～，任意frame为*
   * @param {string} name 消息名
   * @param {*} payload 消息参数
   * @param {*} error 错误信息
   * @return {*} 首个响应消息内容
   */
  dispatch(UUID, name, payload, error) {
    let results = this._handleMessageEvent({
      UUID,
      name,
      payload,
      error,
      isAck: false,
      ack: false,
    })

    return results.slice(0, 1)
  }
}

const ipcPool = new WeakMap()

/**
 * 已绑定了UUID的ipc
 */
export class BoundIpc {
  static setOptions(options) {
    BoundIpc.options = options
  }
  constructor(webview, UUID) {
    this.UUID = UUID

    if (ipcPool.has(webview)) {
      this.executor = ipcPool.get(webview)
    } else {
      this.executor = new Ipc(webview, BoundIpc.options)
      ipcPool.set(webview, this.executor)
    }
  }
  /**
   * 发送消息
   * @param {string|string[]} name 消息名, 支持合并发送payload相同的消息
   * @param {Object} payload 传输数据
   * @param {number} timeout 等待回复时间
   * @param {number} retry 重试次数，默认不重试，仅在超时的情况才会重试
   *
   * @return {Promise&lt;IpcEvent>} 返回promise，等待消息回复内容
   */
  send(name, payload, timeout, retry) {
    return this.executor.send(this.UUID, name, payload, timeout, retry)
  }
  /**
   * 当收到某消息时立即发送指定消息给发送方, 和ack不同
   * @param {string} trigger 触发的消息名
   * @param {string|string[]} name 消息名, 支持合并发送payload相同的消息
   * @param {Object} payload 传输数据
   *
   * @return {BoundIpc} this
   */
  sendOn(trigger, name, payload) {
    this.executor.sendOn(this.UUID, trigger, name, payload)
    return this
  }
  /**
   * 监听消息
   * @param {string|string[]} name 消息名
   * @param {IpcListener} listener 响应函数
   * @param {boolean} unique 同名消息只绑定一次, 再次绑定时会取消前一次的绑定
   *
   * @return {BoundIpc} this
   *
   */
  on(name, listener, unique) {
    this.executor.on(this.UUID, name, listener, unique)
    return this
  }
  /**
   * 单次监听webview内的消息
   * @param {string|string[]} name 消息名
   * @param {IpcListener} listener 响应函数
   *
   * @return {BoundIpc} this
   *
   */
  once(name, listener) {
    this.executor.once(this.UUID, name, listener)
    return this
  }
  /**
   * 取消监听
   * @param {string|string[]} name 消息名
   * @param {IpcListener} listener 响应函数
   *
   * @return {BoundIpc} this
   *
   */
  off(name, listener) {
    this.executor.off(this.UUID, name, listener)
    return this
  }
  /**
   * 手动触发消息
   * @param {string} name 消息名
   * @param {*} payload 消息内容
   * @param {*} error 错误信息
   */
  dispatch(name, payload, error) {
    return this.executor.dispatch(this.UUID, name, payload, error)
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Fri Nov 20 2020 12:04:49 GMT+0800 (GMT+08:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
