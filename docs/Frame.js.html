<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Frame.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BoundIpc.html">BoundIpc</a><ul class='methods'><li data-type='method'><a href="BoundIpc.html#off">off</a></li><li data-type='method'><a href="BoundIpc.html#on">on</a></li><li data-type='method'><a href="BoundIpc.html#once">once</a></li><li data-type='method'><a href="BoundIpc.html#send">send</a></li><li data-type='method'><a href="BoundIpc.html#sendOn">sendOn</a></li></ul></li><li><a href="Browser.html">Browser</a><ul class='methods'><li data-type='method'><a href="Browser.html#bringToFront">bringToFront</a></li><li data-type='method'><a href="Browser.html#build">build</a></li><li data-type='method'><a href="Browser.html#close">close</a></li><li data-type='method'><a href="Browser.html#frontPage">frontPage</a></li><li data-type='method'><a href="Browser.html#getBoundingClientRect">getBoundingClientRect</a></li><li data-type='method'><a href="Browser.html#getPageById">getPageById</a></li><li data-type='method'><a href="Browser.html#init">init</a></li><li data-type='method'><a href="Browser.html#newPage">newPage</a></li><li data-type='method'><a href="Browser.html#pages">pages</a></li></ul></li><li></li><li><a href="BrowserManager.html">BrowserManager</a><ul class='methods'><li data-type='method'><a href="BrowserManager.html#frontBrowser">frontBrowser</a></li><li data-type='method'><a href="BrowserManager.html#get">get</a></li><li data-type='method'><a href="BrowserManager.html#launch">launch</a></li></ul></li><li></li><li><a href="ElementHandle.html">ElementHandle</a><ul class='methods'><li data-type='method'><a href="ElementHandle.html#$">$</a></li><li data-type='method'><a href="ElementHandle.html#$$">$$</a></li><li data-type='method'><a href="ElementHandle.html#$$eval">$$eval</a></li><li data-type='method'><a href="ElementHandle.html#$eval">$eval</a></li><li data-type='method'><a href="ElementHandle.html#$x">$x</a></li><li data-type='method'><a href="ElementHandle.html#asElement">asElement</a></li><li data-type='method'><a href="ElementHandle.html#blur">blur</a></li><li data-type='method'><a href="ElementHandle.html#boxModel">boxModel</a></li><li data-type='method'><a href="ElementHandle.html#check">check</a></li><li data-type='method'><a href="ElementHandle.html#click">click</a></li><li data-type='method'><a href="ElementHandle.html#contentFrame">contentFrame</a></li><li data-type='method'><a href="ElementHandle.html#dispose">dispose</a></li><li data-type='method'><a href="ElementHandle.html#executionContext">executionContext</a></li><li data-type='method'><a href="ElementHandle.html#focus">focus</a></li><li data-type='method'><a href="ElementHandle.html#getAttribute">getAttribute</a></li><li data-type='method'><a href="ElementHandle.html#getAttributes">getAttributes</a></li><li data-type='method'><a href="ElementHandle.html#getBoundingClientRect">getBoundingClientRect</a></li><li data-type='method'><a href="ElementHandle.html#getProperties">getProperties</a></li><li data-type='method'><a href="ElementHandle.html#getProperty">getProperty</a></li><li data-type='method'><a href="ElementHandle.html#hover">hover</a></li><li data-type='method'><a href="ElementHandle.html#isIntersectingViewport">isIntersectingViewport</a></li><li data-type='method'><a href="ElementHandle.html#jsonValue">jsonValue</a></li><li data-type='method'><a href="ElementHandle.html#press">press</a></li><li data-type='method'><a href="ElementHandle.html#screenshot">screenshot</a></li><li data-type='method'><a href="ElementHandle.html#tap">tap</a></li><li data-type='method'><a href="ElementHandle.html#toString">toString</a></li><li data-type='method'><a href="ElementHandle.html#type">type</a></li><li data-type='method'><a href="ElementHandle.html#uncheck">uncheck</a></li><li data-type='method'><a href="ElementHandle.html#uploadFile">uploadFile</a></li></ul></li><li></li><li><a href="EventEmitter.html">EventEmitter</a><ul class='methods'><li data-type='method'><a href="EventEmitter.html#.noConflict">noConflict</a></li></ul></li><li><a href="Frame.html">Frame</a><ul class='methods'><li data-type='method'><a href="Frame.html#addScriptTag">addScriptTag</a></li><li data-type='method'><a href="Frame.html#addStyleTag">addStyleTag</a></li><li data-type='method'><a href="Frame.html#blur">blur</a></li><li data-type='method'><a href="Frame.html#childFrames">childFrames</a></li><li data-type='method'><a href="Frame.html#click">click</a></li><li data-type='method'><a href="Frame.html#content">content</a></li><li data-type='method'><a href="Frame.html#evaluate">evaluate</a></li><li data-type='method'><a href="Frame.html#focus">focus</a></li><li data-type='method'><a href="Frame.html#goto">goto</a></li><li data-type='method'><a href="Frame.html#hover">hover</a></li><li data-type='method'><a href="Frame.html#isDetached">isDetached</a></li><li data-type='method'><a href="Frame.html#localStorageGet">localStorageGet</a></li><li data-type='method'><a href="Frame.html#localStorageKeys">localStorageKeys</a></li><li data-type='method'><a href="Frame.html#localStorageRemove">localStorageRemove</a></li><li data-type='method'><a href="Frame.html#localStorageSet">localStorageSet</a></li><li data-type='method'><a href="Frame.html#name">name</a></li><li data-type='method'><a href="Frame.html#page">page</a></li><li data-type='method'><a href="Frame.html#parentFrame">parentFrame</a></li><li data-type='method'><a href="Frame.html#select">select</a></li><li data-type='method'><a href="Frame.html#setContent">setContent</a></li><li data-type='method'><a href="Frame.html#tap">tap</a></li><li data-type='method'><a href="Frame.html#title">title</a></li><li data-type='method'><a href="Frame.html#type">type</a></li><li data-type='method'><a href="Frame.html#url">url</a></li><li data-type='method'><a href="Frame.html#waitFor">waitFor</a></li><li data-type='method'><a href="Frame.html#waitForFunction">waitForFunction</a></li><li data-type='method'><a href="Frame.html#waitForNavigation">waitForNavigation</a></li><li data-type='method'><a href="Frame.html#waitForSelector">waitForSelector</a></li><li data-type='method'><a href="Frame.html#waitForXPath">waitForXPath</a></li></ul></li><li></li><li><a href="Ipc.html">Ipc</a><ul class='methods'><li data-type='method'><a href="Ipc.html#off">off</a></li><li data-type='method'><a href="Ipc.html#on">on</a></li><li data-type='method'><a href="Ipc.html#once">once</a></li><li data-type='method'><a href="Ipc.html#send">send</a></li><li data-type='method'><a href="Ipc.html#sendOn">sendOn</a></li></ul></li><li></li><li><a href="Page.html">Page</a><ul class='methods'><li data-type='method'><a href="Page.html#bringToFront">bringToFront</a></li><li data-type='method'><a href="Page.html#browser">browser</a></li><li data-type='method'><a href="Page.html#build">build</a></li><li data-type='method'><a href="Page.html#canGoBack">canGoBack</a></li><li data-type='method'><a href="Page.html#canGoForward">canGoForward</a></li><li data-type='method'><a href="Page.html#close">close</a></li><li data-type='method'><a href="Page.html#cookies">cookies</a></li><li data-type='method'><a href="Page.html#deleteCookies">deleteCookies</a></li><li data-type='method'><a href="Page.html#evaluateHandle">evaluateHandle</a></li><li data-type='method'><a href="Page.html#find">find</a></li><li data-type='method'><a href="Page.html#frames">frames</a></li><li data-type='method'><a href="Page.html#goBack">goBack</a></li><li data-type='method'><a href="Page.html#goForward">goForward</a></li><li data-type='method'><a href="Page.html#init">init</a></li><li data-type='method'><a href="Page.html#isClosed">isClosed</a></li><li data-type='method'><a href="Page.html#isLoading">isLoading</a></li><li data-type='method'><a href="Page.html#isLoadingMainFrame">isLoadingMainFrame</a></li><li data-type='method'><a href="Page.html#mainFrame">mainFrame</a></li><li data-type='method'><a href="Page.html#queryObjects">queryObjects</a></li><li data-type='method'><a href="Page.html#reload">reload</a></li><li data-type='method'><a href="Page.html#screenshot">screenshot</a></li><li data-type='method'><a href="Page.html#setCookie">setCookie</a></li><li data-type='method'><a href="Page.html#waitForRequest">waitForRequest</a></li><li data-type='method'><a href="Page.html#waitForResponse">waitForResponse</a></li></ul></li><li></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">Frame.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import EventEmitter from "./EventEmitter.js";
import ElementHandle from "./ElementHandle.js";
import { BoundIpc } from "./ipc.js";
import { TimeoutPromise, proxyBindDecorator } from "./util.js";

/**
 * @class Frame Frame类，webview的iframe，主页面是mainFrame
 * @extends EventEmitter
 * 
 * @property {WebviewTag} webview 
 * @property {boolean} isMainFrame 是否mainFrame
 * @property {Ipc} ipc ipc通信实例，可用于和webview内内容通信
 * @property {ElementHandle} document 当前frame的document操作句柄
 * 
 * 以下方法是绑定在frame的document下运行的，由ElementHandle类实现
 * @property {Function} $
 * @property {Function} $$
 * @property {Function} $eval
 * @property {Function} $$eval
 * @property {Function} $x
 * 
 */
class Frame extends EventEmitter {
  /**
   * @typedef FrameInfo frame信息
   * @property {string} FrameInfo.UUID iframe的UUID值
   * @property {string} FrameInfo.name iframe的name值
   * @property {boolean} FrameInfo.isMainFrame 是否为mainFrame
   * @property {FrameInfo} FrameInfo.parent 父的frame的信息
   */

  /**
   *
   * @constructor Frame
   * @param {Page} page 所属page实例
   * @param {WebviewTag} webviewElement webview节点
   * @param {FrameInfo} frameInfo frame的信息
   */
  constructor(page, webviewElement, frameInfo) {
    super();

    this._frameInfo = frameInfo;

    this._page = page;
    this.webview = webviewElement;
    // webview的webContentsId
    this._webContentsId = frameInfo.routingId;
    this.isMainFrame = frameInfo.isMainFrame;
    this.ipc = new BoundIpc(this.webview, frameInfo.UUID);
    this.document = new ElementHandle(this, "document", []);

    this._childFrames = [];
    this._listenChildFramesRegister();
    this._listenChildFramesUnregister();
  }
  // 监听当前frame下子iframe的注册事件
  _listenChildFramesRegister() {
    this.ipc.on("childFrame.register", (frameInfo) => {
      let originInfo = this._childFrames.find(
        (item) => item.UUID === frameInfo.UUID
      );
      if (originInfo) {
        Object.assign(originInfo, frameInfo);
      } else {
        this._childFrames.push(frameInfo);
      }
    });
  }
  // 监听当前frame下子iframe的注销事件
  _listenChildFramesUnregister() {
    this.ipc.on("childFrame.unregister", (frameInfo) => {
      this._childFrames = this._childFrames.filter(
        (item) => item.UUID !== frameInfo.UUID
      );
    });
  }
  /**
   * 注入一个指定url或(content)的script标签到页面
   * @param {Object} options 
   * @property {string} [options.url] 要添加的script的src
   * @property {string} [options.content] 要注入页面的js代码
   * @property {boolean} [options.waitLoad] 如果是url，等待onload回调
   * @property {string} [options.type] type属性，如果要注入 ES6 module，值为'module'
   * 
   * @return {Promise&lt;ElementHandle>} 返回注入脚本的dom句柄实例
   */
  addScriptTag(options) {
    return this.ipc.send("frame.addScriptTag", options);
  }
  /**
   * 注入一个link(url)或style(content)标签到页面
   * @param {Object} options 
   * @property {string} [options.url] 要添加的css link的src
   * @property {string} [options.content] 要注入页面的style代码
   * 
   * @return {Promise&lt;ElementHandle>} 返回注入样式的dom句柄实例
   */
  addStyleTag(options) {
    return this.ipc.send("frame.addStyleTag", options);
  }
  /**
   * 获取当前frame
   */
  childFrames() {
    return this._childFrames.map(
      (info) =>
        new Frame(this._page, this.webview, {
          ...info,
          parent: this._frameInfo,
        })
    );
  }
  /**
   * todo
   * 获取frame的内容
   * 
   * @return {string}
   */
  content() {
    return this.ipc.send("frame.content");
  }
  /**
   * 在frame运行指定函数
   * @param {Function} pageFunction 
   * @param {string[]|number[]} args 传给pageFunction的参数  
   * @param {number} [timeout]  等待超时时间
   * 
   * @return {Promise&lt;*>} 返回运行结果，若pageFunction返回Promise，会等待Promise的resolve结果
   */
  evaluate(pageFunction, args, timeout) {
    if (!Array.isArray(args)) {
      timeout = args;
      args = [];
    }

    args = args.map(function(arg) {
      return JSON.stringify(arg);
    });

    if (typeof pageFunction == "string") {
      pageFunction = "function() {return " + pageFunction + "}";
    }

    return this.ipc.send(
      "frame.evaluate",
      { pageFunction: pageFunction.toString(), args: args },
      timeout
    );
  }
  /**
   * 控制当前frame跳转到指定url
   * 会在超时时间内追踪重定向，直到跳转到最终页面
   * @param {string} url 
   * @param {Object} [options] 
   * @property {string} [options.waitUntil] 认定跳转成功的事件类型 load|domcontentloaded，默认为domcontentloaded
   * @property {number} [options.timeout] 超时时间，单位为ms，默认为5000ms
   * 
   * @return {Promise&lt;undefined>}
   */
  async goto(url, options) {
    let timeout = (options &amp;&amp; options.timeout) || 5e3;
    var waitUntil = (options &amp;&amp; options.waitUntil) || "domcontentloaded";

    // 递归获取最终的跳转地址
    // timeout计时结束后就停止监听跳转
    var redirectURL = url;
    const _getRedirectUrl = () => {
      this.page().webRequest.onBeforeRedirect(
        {
          urls: ["http://*/*", "https://*/*"],
        },
        (details) => {
          if (details.url === redirectURL) {
            redirectURL = details.redirectURL;
            // console.log('onBeforeRedirect: ', redirectURL)
          }
        }
      );
    };
    _getRedirectUrl();

    await this.ipc.send("frame.goto", {
      url: url,
    });

    return new TimeoutPromise((resolve) => {
      this.ipc.on("frame.goto." + waitUntil, (payload) => {
        if (payload.url === redirectURL) {
          resolve(payload);
        }
      });
    }, timeout).catch(err => {
      if (err === 'promise.timeout') {
        return Promise.reject("goto.timeout")
      }
      return Promise.reject(err)
    });
  }
  /**
   * todo 
   */
  isDetached() {
    return Promise.reject("todo");
  }
  /**
   * frame的名称
   * 
   * @return {string}
   */
  name() {
    return this._frameInfo.name;
  }
  /**
   * frame所属的page实例
   * 
   * @return {Page}
   */
  page() {
    return this._page;
  }
  /**
   * frame的parentFrame
   * 如果当前frame为mainFrame，返回null
   * 
   * @return {Frame}
   */
  parentFrame() {
    if (this._frameInfo.parent) {
      return new Frame(this._page, this.webview, this._frameInfo.parent);
    }
    return null;
  }
  /**
   * todo
   */
  select() {
    return Promise.reject("todo");
  }
  /**
   * todo 
   * 设置页面内容
   * @param {string} html
   * 
   * @return {Promise&lt;undefined>}
   */
  setContent(html) {
    return this.ipc.send("frame.setContent", html);
  }
  /**
   * frame的标题
   * 
   * @return {string}
   */
  title() {
    if (this.isMainFrame) {
      return this.webview.getTitle();
    }

    return this.ipc.send("frame.title");
  }
  /**
   * todo 
   * 未实现，请使用press方法
   * 输入指定内容
   * @param {string} selector 要输入的dom的选择，input或textarea
   * @param {string} text 输入的文本
   * @param {Object} [options]
   * @property {number} [options.delay] // 延迟输入, 操作更像用户
   */
  type(selector, text, options) {
    return this.ipc.send("frame.type", { selector, text, options });
  }
  /**
   * 获取url，如果是mainFrame为当前url，如果是iframe，则是src属性
   * 
   * @return {string}
   */
  url() {
    if (this.isMainFrame) {
      return this.webview.getURL();
    }

    return this._frameInfo.url;
  }
  /**
   * waitForSelector|waitForFunction|setTimeout的结合体
   * @param {string|number|Function} selectorOrFunctionOrTimeout 
   * @param {Object} options 
   * @param  {...any} args 
   */
  waitFor(selectorOrFunctionOrTimeout, options, ...args) {
    if (typeof selectorOrFunctionOrTimeout === "string") {
      return this.waitForSelector(selectorOrFunctionOrTimeout, options);
    } else if (typeof selectorOrFunctionOrTimeout === "number") {
      return new Promise((resolve) => {
        setTimeout(resolve, selectorOrFunctionOrTimeout);
      });
    } else {
      return this.waitForFunction(
        selectorOrFunctionOrTimeout,
        options,
        ...args
      );
    }
  }
  /**
   * 在指定时间内轮询执行方法，直到方法返回true
   * @param {Function} pageFunction 
   * @param {Object} [options]
   * @property {number} [options.timeout] 等待时间
   * @param  {...any} args 
   * 
   * @return {Promise&lt;boolean>} 成功返回resove(true)，超时返回reject
   */
  waitForFunction(pageFunction, options, ...args) {
    if (typeof pageFunction == "string") {
      pageFunction = "function() {return " + pageFunction + "}";
    }

    return this.ipc.send("frame.waitForFunction", {
      pageFunction: pageFunction.toString(),
      args: args,
      options,
    });
  }
  /**
   * 等待跳转完成
   * @param {Object} [options] 
   * @property {string} [options.waitUntil] 认定跳转成功的事件类型 load|domcontentloaded，默认为domcontentloaded
   * @property {number} [options.timeout] 超时时间，单位为ms，默认为5000ms
   * 
   * @return {Promise&lt;Object>} 返回跳转后frame的信息
   */
  waitForNavigation(options) {
    return new TimeoutPromise((resolve, reject) => {
      var waitUntil = (options &amp;&amp; options.waitUntil) || "domcontentloaded";
      this.ipc.once("frame.waitForNavigation." + waitUntil, function(param) {
        resolve(param);
      });
    }, (options &amp;&amp; options.timeout) || 5e3).catch(err => {
      if (err === 'promise.timeout') {
        return Promise.reject("waitForNavigation.timeout")
      }
      return Promise.reject(err)
    });
  }
  /**
   * 在指定时间内轮询查询dom节点，直到查找到节点
   * @param {string} selector dom节点选择器
   * @param {Object} [options] 
   * @property {boolean} [options.visible] 节点是否可见，如果visible为true时必须查到到dom节点且可见才会返回true
   * @property {number} [options.timeout] 超时时间，单位为ms，默认为10000ms
   * 
   * @return {Promise&lt;undefined>} 成功则resolve，失败返回reject
   */
  waitForSelector(selector, options) {
    return this.ipc.send(
      "frame.waitForSelector",
      {
        selector: selector,
        options: options,
      },
      options &amp;&amp; options.timeout
    )
  }
  /**
   * todo
   */
  waitForXPath(xpath, options) {
    return Promise.reject("todo");
  }
  /**
   * 点击frame内的指定节点
   * @param {string} selector 选择器
   * @param {Object} options 暂不支持
   * 
   * @return {Promise&lt;boolean>}
   */
  click(selector, options) {
    return this.document.$(selector).click(options);
  }
  /**
   * 聚焦frame内的指定节点
   * @param {string} selector 选择器
   * @param {Object} options 暂不支持
   * 
   * @return {Promise&lt;boolean>}
   */
  focus(selector, options) {
    return this.document.$(selector).focus(options);
  }
  /**
   * 取消聚焦frame内的指定节点
   * @param {string} selector 选择器
   * @param {Object} options 暂不支持
   * 
   * @return {Promise&lt;boolean>}
   */
  blur(selector, options) {
    return this.document.$(selector).blur(options);
  }
  /**
   * 鼠标移入frame内的指定节点，对应mouseover事件
   * @param {string} selector 选择器
   * @param {Object} options 暂不支持
   * 
   * @return {Promise&lt;boolean>}
   */
  hover(selector, options) {
    return this.document.$(selector).hover(options);
  }
  /**
   * todo
   */
  tap(selector, options) {
    return this.document.$(selector).tap(options);
  }
  /**
   * 获取localStorage的所有key集合
   */
  localStorageKeys() {
    return this.ipc.send("frame.localStorageKeys");
  }
  /**
   * localStorage.getItem
   * @param {string} key 
   * 
   * @return {Promise&lt;string>}
   */
  localStorageGet(key) {
    return this.ipc.send("frame.localStorageGet", {
      key: key,
    });
  }
   /**
   * localStorage.setItem
   * @param {string} key 
   * @param {string} value 
   * 
   * @return {Promise&lt;undefined>}
   */
  localStorageSet(key, value) {
    return this.ipc.send("frame.localStorageSet", {
      key: key,
      value: value,
    });
  }
   /**
   * localStorage.removeItem
   * @param {string} key 
   * 
   * @return {Promise&lt;undefined>}
   */
  localStorageRemove(key) {
    return this.ipc.send("frame.localStorageRemove", {
      key: key,
    });
  }
}

export default proxyBindDecorator(
  ["$", "$$", "$eval", "$$eval", "$x"],
  function() {
    return this.document;
  }
)(Frame);
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Fri May 08 2020 20:10:58 GMT+0800 (GMT+08:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
